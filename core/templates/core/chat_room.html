{% extends 'core/base.html' %}

{% block content %}
<div class="container my-5">
    <div class="chat-container">
        <h2>Chat for course "{{ course.title }}"</h2>
        <div id="chat-log">
            </div>
        <div class="chat-input-area">
            <input type="text" id="chat-message-input" class="form-control">
            <button id="chat-message-submit" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // All code runs only after the full HTML document is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const roomName = "{{ course.id }}";
        const chatLog = document.getElementById('chat-log');
        const messageInputDom = document.getElementById('chat-message-input');
        const messageSubmitBtn = document.getElementById('chat-message-submit');

        console.log("Attempting to connect to WebSocket...");

        // Explicitly specify host and port for the WebSocket connection
        const chatSocket = new WebSocket(
            'ws://' + window.location.hostname + ':8001' + '/ws/chat/' + roomName + '/'
        );
        
        // Log successful connection opening
        chatSocket.onopen = function(e) {
            console.log("WebSocket connection opened successfully.");
        };

        // Handle incoming messages from the server
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            
            const p = document.createElement('p');
            p.textContent = message;
            chatLog.appendChild(p);

            console.log("Message received from server: " + message);
        };

        // Log connection close
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Log connection errors
        chatSocket.onerror = function(e) {
            console.error('WebSocket error occurred:', e);
        };

        // Handle Enter key press
        if (messageInputDom) {
            messageInputDom.focus();
            messageInputDom.onkeyup = function(e) {
                if (e.key === 'Enter') {
                    messageSubmitBtn.click();
                }
            };
        }

        // Handle "Send" button click
        if (messageSubmitBtn) {
            messageSubmitBtn.onclick = function(e) {
                const message = messageInputDom.value;

                if (message.trim() !== '') {
                    // Check that the connection is open (readyState === 1) before sending
                    if (chatSocket.readyState === WebSocket.OPEN) {
                        chatSocket.send(JSON.stringify({
                            'message': message
                        }));
                        console.log("Message sent: " + message);
                        messageInputDom.value = '';
                    } else {
                        console.error("WebSocket is not open. ReadyState:", chatSocket.readyState);
                        console.error("Message was not sent.");
                    }
                }
            };
        }
    });
</script>
{% endblock %}
